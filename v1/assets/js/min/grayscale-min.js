var grayscale=function(){var e={colorProps:["color","backgroundColor","borderBottomColor","borderTopColor","borderLeftColor","borderRightColor","backgroundImage"],externalImageHandler:{init:function(e,t){"img"===e.nodeName.toLowerCase()||(r(e).backgroundImageSRC=t,e.style.backgroundImage="")},reset:function(e){"img"===e.nodeName.toLowerCase()||(e.style.backgroundImage="url("+(r(e).backgroundImageSRC||"")+")")}}},t=function(){try{window.console.log.apply(console,arguments)}catch(e){}},a=function(e){return new RegExp("https?://(?!"+window.location.hostname+")").test(e)},r=function(){var e=[0],t="data"+ +new Date;return function(a){var r=a[t],n=e.length;return r||(r=a[t]=n,e[r]={}),e[r]}}(),n=function(e,t,a){var o=document.createElement("canvas"),i=o.getContext("2d"),c=e.naturalHeight||e.offsetHeight||e.height,g=e.naturalWidth||e.offsetWidth||e.width,d;o.height=c,o.width=g,i.drawImage(e,0,0);try{d=i.getImageData(0,0,g,c)}catch(s){}if(t){n.preparing=!0;var u=0;return void function(){if(n.preparing){u===c&&(i.putImageData(d,0,0,0,0,g,c),a?r(a).BGdataURL=o.toDataURL():r(e).dataURL=o.toDataURL());for(var t=0;g>t;t++){var s=4*(u*g+t);d.data[s]=d.data[s+1]=d.data[s+2]=l(d.data[s],d.data[s+1],d.data[s+2])}u++,setTimeout(arguments.callee,0)}}()}n.preparing=!1;for(var u=0;c>u;u++)for(var m=0;g>m;m++){var f=4*(u*g+m);d.data[f]=d.data[f+1]=d.data[f+2]=l(d.data[f],d.data[f+1],d.data[f+2])}return i.putImageData(d,0,0,0,0,g,c),o},o=function(e,t){var a=document.defaultView&&document.defaultView.getComputedStyle?document.defaultView.getComputedStyle(e,null)[t]:e.currentStyle[t];if(a&&/^#[A-F0-9]/i.test(a)){var r=a.match(/[A-F0-9]{2}/gi);a="rgb("+parseInt(r[0],16)+","+parseInt(r[1],16)+","+parseInt(r[2],16)+")"}return a},l=function(e,t,a){return parseInt(.2125*e+.7154*t+.0721*a,10)},i=function(e){var t=Array.prototype.slice.call(e.getElementsByTagName("*"));return t.unshift(e),t},c=function(t){if(t&&t[0]&&t.length&&t[0].nodeName)for(var g=Array.prototype.slice.call(t),d=-1,s=g.length;++d<s;)c.call(this,g[d]);else{if(t=t||document.documentElement,!document.createElement("canvas").getContext)return t.style.filter="progid:DXImageTransform.Microsoft.BasicImage(grayscale=1)",void(t.style.zoom=1);for(var u=i(t),m=-1,f=u.length;++m<f;){var v=u[m];if("img"===v.nodeName.toLowerCase()){var p=v.getAttribute("src");if(!p)continue;if(a(p))e.externalImageHandler.init(v,p);else{r(v).realSRC=p;try{v.src=r(v).dataURL||n(v).toDataURL()}catch(h){e.externalImageHandler.init(v,p)}}}else for(var y=0,I=e.colorProps.length;I>y;y++){var C=e.colorProps[y],b=o(v,C);if(b)if(v.style[C]&&(r(v)[C]=b),"rgb("!==b.substring(0,4)){if(b.indexOf("url(")>-1){var w=/\(['"]?(.+?)['"]?\)/,x=b.match(w)[1];if(a(x)){e.externalImageHandler.init(v,x),r(v).externalBG=!0;continue}try{var L=r(v).BGdataURL||function(){var e=document.createElement("img");return e.src=x,n(e).toDataURL()}();v.style[C]=b.replace(w,function(e,t){return"("+L+")"})}catch(h){e.externalImageHandler.init(v,x)}}}else{var R=l.apply(null,b.match(/\d+/g));v.style[C]=b="rgb("+R+","+R+","+R+")"}}}}};return c.reset=function(t){if(t&&t[0]&&t.length&&t[0].nodeName)for(var n=Array.prototype.slice.call(t),o=-1,l=n.length;++o<l;)c.reset.call(this,n[o]);else{if(t=t||document.documentElement,!document.createElement("canvas").getContext)return void(t.style.filter="progid:DXImageTransform.Microsoft.BasicImage(grayscale=0)");for(var g=i(t),d=-1,s=g.length;++d<s;){var u=g[d];if("img"===u.nodeName.toLowerCase()){var m=u.getAttribute("src");a(m)&&e.externalImageHandler.reset(u,m),u.src=r(u).realSRC||m}else for(var f=0,v=e.colorProps.length;v>f;f++){r(u).externalBG&&e.externalImageHandler.reset(u);var p=e.colorProps[f];u.style[p]=r(u)[p]||""}}}},c.prepare=function(e){if(e&&e[0]&&e.length&&e[0].nodeName)for(var t=Array.prototype.slice.call(e),l=-1,g=t.length;++l<g;)c.prepare.call(null,t[l]);else if(e=e||document.documentElement,document.createElement("canvas").getContext)for(var d=i(e),s=-1,u=d.length;++s<u;){var m=d[s];if(r(m).skip)return;if("img"===m.nodeName.toLowerCase())m.getAttribute("src")&&!a(m.src)&&n(m,!0);else{var f=o(m,"backgroundImage");if(f.indexOf("url(")>-1){var v=/\(['"]?(.+?)['"]?\)/,p=f.match(v)[1];if(!a(p)){var h=document.createElement("img");h.src=p,n(h,!0,m)}}}}},c}();
